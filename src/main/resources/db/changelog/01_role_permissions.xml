<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="role table" author="pal.chandrakanta@gmail.com">
        <createTable tableName="role">
            <column name="id" type="uuid">
                <constraints nullable="false" uniqueConstraintName="PK_role" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="display_name" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(4096)">
                <constraints nullable="true"/>
            </column>
            <column name="subscription_id" type="uuid">
                <constraints nullable="true"/>
            </column>
            <column name="is_sys_role" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="is_read_only" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="UNQ_SYS_ROLE_NAME index" author="pal.chandrakanta@gmail.com">
        <createIndex tableName="role" indexName="UNQ_SYS_ROLE_NAME" unique="true">
            <column name="lower(name)"/>
        </createIndex>
        <modifySql>
            <append value=" WHERE subscription_id is  null"/>
        </modifySql>
    </changeSet>

    <changeSet id="UNQ_SUBSCRIPTION_ROLE_NAME index" author="pal.chandrakanta@gmail.com">
        <createIndex tableName="role" indexName="UNQ_SUBSCRIPTION_ROLE_NAME" unique="true">
            <column name="lower(name)"/>
            <column name="subscription_id"/>
        </createIndex>
        <modifySql>
            <append value=" WHERE subscription_id is not null"/>
        </modifySql>
    </changeSet>

    <changeSet id="SYSTEM_ADMIN and ADMIN Role" author="pal.chandrakanta@gmail.com">
        <insert tableName="role">
            <column name="id">9d03ceaa-c582-11e7-b806-0758598c7c0f</column>
            <column name="name">ADMIN</column>
            <column name="display_name">Admin</column>
            <column name="description">Administrator. User with this role can perform all tasks.</column>
            <column name="is_sys_role">FALSE</column>
            <column name="is_read_only">TRUE</column>
            <column name="is_active">TRUE</column>
        </insert>
        <insert tableName="role">
            <column name="id">9432f028-f809-496b-8fbe-6ef9166069df</column>
            <column name="name">SYSTEM_ADMIN</column>
            <column name="display_name">System Admin</column>
            <column name="description">
                System Administrator. User with this role can perform all task in application level.
            </column>
            <column name="is_sys_role">TRUE</column>
            <column name="is_read_only">TRUE</column>
            <column name="is_active">TRUE</column>
        </insert>
    </changeSet>

    <changeSet id="permission table" author="pal.chandrakanta@gmail.com">
        <createTable tableName="permission">
            <column name="id" type="uuid">
                <constraints nullable="false" uniqueConstraintName="PK_permission" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(2048)">
                <constraints nullable="false"/>
            </column>
            <column name="display_name" type="varchar(2048)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(4096)"/>
            <column name="parent_permission" type="uuid">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="role permissions" author="pal.chandrakanta@gmail.com">
        <createTable tableName="role_has_permissions">
            <column name="role_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="permission_id" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="role_has_permissions" indexName="UNQ_ROLE_HAS_PERMISSIONS" unique="true">
            <column name="role_id"/>
            <column name="permission_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="role grant role" author="pal.chandrakanta@gmail.com">
        <createTable tableName="role_can_grant_roles">
            <column name="role_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="can_grant_role" type="uuid">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="role_can_grant_roles" indexName="UNQ_ROLE_CAN_GRANT_ROLE" unique="true">
            <column name="role_id"/>
            <column name="can_grant_role"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>